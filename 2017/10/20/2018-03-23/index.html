<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://zksyp.com">
  <title>Android项目组件化尝试小结 | Zksyp的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="为什么组件化   组件化想法大概是从16年6月份的时候项目老大提出来的，当时我们的项目只有一个module。堆积大量代码，但是又分了几个业务线，各个业务线又很独立，各业务线按照自己的节奏在开发迭代版本。随着app近一年的迭代，app已经越来越庞大，业务线也越来越多，AS的项目构建速度也越来越慢，有时候甚至都会卡死！现在稳定在迭代的有A，B，C，D等(因涉及公司隐私，这里用字母代替了)，有些业务线之">
<meta property="og:type" content="article">
<meta property="og:title" content="Android项目组件化尝试小结">
<meta property="og:url" content="http://zksyp.com/2017/10/20/2018-03-23/index.html">
<meta property="og:site_name" content="Zksyp的博客">
<meta property="og:description" content="为什么组件化   组件化想法大概是从16年6月份的时候项目老大提出来的，当时我们的项目只有一个module。堆积大量代码，但是又分了几个业务线，各个业务线又很独立，各业务线按照自己的节奏在开发迭代版本。随着app近一年的迭代，app已经越来越庞大，业务线也越来越多，AS的项目构建速度也越来越慢，有时候甚至都会卡死！现在稳定在迭代的有A，B，C，D等(因涉及公司隐私，这里用字母代替了)，有些业务线之">
<meta property="og:image" content="http://og407vfi8.bkt.clouddn.com/结构.png">
<meta property="og:image" content="http://og407vfi8.bkt.clouddn.com/rpc架构.png">
<meta property="og:image" content="http://og407vfi8.bkt.clouddn.com/运行.png">
<meta property="og:image" content="http://og407vfi8.bkt.clouddn.com/15225931350473.jpg">
<meta property="og:updated_time" content="2018-04-01T15:29:37.772Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android项目组件化尝试小结">
<meta name="twitter:description" content="为什么组件化   组件化想法大概是从16年6月份的时候项目老大提出来的，当时我们的项目只有一个module。堆积大量代码，但是又分了几个业务线，各个业务线又很独立，各业务线按照自己的节奏在开发迭代版本。随着app近一年的迭代，app已经越来越庞大，业务线也越来越多，AS的项目构建速度也越来越慢，有时候甚至都会卡死！现在稳定在迭代的有A，B，C，D等(因涉及公司隐私，这里用字母代替了)，有些业务线之">
<meta name="twitter:image" content="http://og407vfi8.bkt.clouddn.com/结构.png">
  
    <link rel="alternative" href="/atom.xml" title="Zksyp的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/assets/img/favicon.ico">
  
  <link rel="stylesheet" href="/main.css">
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/assets/blogImg/zksyp.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Zksyp</a></h1>
		</hgroup>

		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/photos">相册</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">标签</a>
    			
    			
            
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/zksyp" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="/" title="weibo">weibo</a>
		        
					<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">Zksyp</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="/assets/blogImg/zksyp.jpg" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">Zksyp</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/photos">相册</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/zksyp" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="/" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        <article id="post-2018-03-23" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android项目组件化尝试小结
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="为什么组件化"><a href="#为什么组件化" class="headerlink" title="为什么组件化"></a>为什么组件化</h2><p>   组件化想法大概是从16年6月份的时候项目老大提出来的，当时我们的项目只有一个module。堆积大量代码，但是又分了几个业务线，各个业务线又很独立，各业务线按照自己的节奏在开发迭代版本。随着app近一年的迭代，app已经越来越庞大，业务线也越来越多，AS的项目构建速度也越来越慢，有时候甚至都会卡死！现在稳定在迭代的有A，B，C，D等(因涉及公司隐私，这里用字母代替了)，有些业务线之间是完全无联系的，但有些又有不少联系。为了让业务线相互隔离，也为了让开发们在做自己业务的功能的时候只需要关注自己的模块，我们在11月份的时候开始启动了项目组件化。开始了解耦之路。。<br><a id="more"></a></p>
<h2 id="什么是组件化"><a href="#什么是组件化" class="headerlink" title="什么是组件化"></a>什么是组件化</h2><p>   当老大说开始组件化的时候，我还是有点懵逼的，因为我映象里只是听说过这个名词，但对其里面的具体内容还是没有什么概念的。于是google一波查了下大致的介绍，做了个简单的概括：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">组件化不是一门高深的黑科技，只是通过合理的分业务module，各自独立，module与module之间充分解耦，并通过灵活的gradle配置方式来实现debug和release时互不影响。在开发阶段还能通过单独构建一个独立的业务module来节省编译构建时间，让各个业务组开发能更快地编译，更加focus在自己业务组的业务上。组件化是基于编译时的，跟插件化的基于运行时是不同的，想了解两者之间的差异请自行google。</div></pre></td></tr></table></figure>
<h2 id="组件化之路——总体框架"><a href="#组件化之路——总体框架" class="headerlink" title="组件化之路——总体框架"></a>组件化之路——总体框架</h2><p>  现在项目的框架结构图如下图所示：<br><img src="http://og407vfi8.bkt.clouddn.com/结构.png" alt="结构"></p>
<p>  简单来讲从上到下分三层，App层，业务层和基础框架层。当以app宿主的时候，我们进行全量编译，把所有的业务module都打包进去，当业务线平时开发的时候只需对单个module进行编译，基础框架层的module全部作为aar进行应用就可以了。接下来我来介绍下个模块的划分与功能。</p>
<h3 id="基础服务层-lib-basic-module-lib-rpc-lib-domain-lib-tools"><a href="#基础服务层-lib-basic-module-lib-rpc-lib-domain-lib-tools" class="headerlink" title="基础服务层(lib_basic_module,lib_rpc,lib_domain,lib_tools)"></a>基础服务层(lib_basic_module,lib_rpc,lib_domain,lib_tools)</h3><p>  基础服务层是项目的基础架构，目前包含了4个模块，从下到上形成一个模块依赖链。该层是项目的底层架构，为所有的业务模块提供公共的服务。</p>
<ul>
<li>lib_tools(底层工具): 提供通用的与android无关的java方法。如：日志，加密。目标是聚合通用方法，能够以jar格式，在公司各个app项目之间通用。</li>
<li>lib_domian(底层模型): 提供最底层的数据模型。通用的数据模型通常会在各个业务模块间通用的数据模型会放在该层中。</li>
<li>lib_rpc(模块间调用连接器): 提供业务模块间的通信，每个业务module都需要在rpc中注册交互使用的接口，然后在各自对应的module中对这个注册接口进行实现。然后宿主App通过一个ModuleServiceManager来进行管理各个业务module。主要架构图如下:<br>  <img src="http://og407vfi8.bkt.clouddn.com/rpc架构.png" alt="rpc架构"></li>
</ul>
<ul>
<li>lib_basic_module(基础层): 包含了项目的基础服务+模块的基础架构。提供全局的与具体业务无关的组件方法.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">基础服务包括: 数据库，图片加载，网络调用，tinker补丁，定位，埋点，toast提示，推送，权限...等等. </div><div class="line">基础架构包括: Activity Fragment的基类，adapter的基类，各种控件的基类，appliatoin的基类...等</div></pre></td></tr></table></figure>
<h3 id="公共业务层-lib-basic-biz"><a href="#公共业务层-lib-basic-biz" class="headerlink" title="公共业务层(lib_basic_biz)"></a>公共业务层(lib_basic_biz)</h3><p>  该层是将项目的通用业务进行整合，解构，供上层依赖调用。该层只包含业务相关的服务，并且是各个模块间公用，独立业务模块单独的业务不放在该层。</p>
<ul>
<li>lib_basic_biz: 与lib_basic_module的功能类似。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">区别是: 提供全局的业务息息相关的服务。 例如：分享，权限认证，选择车型，选择城市，推送跳转,图片浏览，图片选择等等。</div><div class="line">这些服务的特点是: 各个子业务模块都频繁调用。</div></pre></td></tr></table></figure>
<h3 id="业务模块层-module-a"><a href="#业务模块层-module-a" class="headerlink" title="业务模块层(module_a,**)"></a>业务模块层(module_a,**)</h3><p>这一层就是各业务模块的具体实现了，里面只涉及各具体业务的逻辑，当需要调用其他业务时，通过lib_rpc去跳转调用。</p>
<h2 id="组件化之路——编译配置"><a href="#组件化之路——编译配置" class="headerlink" title="组件化之路——编译配置"></a>组件化之路——编译配置</h2><p>分模块后，build.gradle的文件也需要统一管理。具体实践：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1. 所有子模块的&quot;build.gradle&quot;文件都必须在开头引用lib_gradle_scripts模块中的&quot;subModuleHeader.gradle&quot;文件。</div><div class="line">2. 由于&quot;subModuleHeader.gradle&quot;完成了所有的通用配置，包括版本，签名，混淆等和dependency中的部分通用依赖。所以引用了之后，子模块的build.gradle只需要填写自身特有的配置，比如manifestPlaceholders，以及独有的依赖。</div></pre></td></tr></table></figure>
<h2 id="组件化之路——模块独立运行"><a href="#组件化之路——模块独立运行" class="headerlink" title="组件化之路——模块独立运行"></a>组件化之路——模块独立运行</h2><p>  项目模块数增长后，开发时的编译就会非常耗时。为了提高开发时的效率，设计了一种以AAR依赖为核心的设计，使得我们在开发的过程中，可以让某个业务模块作为独立的app运行，大大提高开发效率。 从多模块编译，到独立模块编译的示意图如下：</p>
<p><img src="http://og407vfi8.bkt.clouddn.com/运行.png" alt="运行"></p>
<p>  这里以ModuleA为例，当以app为宿主的时候，ModuleA是作为一个library，但当它自己作为独立编译的module的时候又要成为一个application。这里我们可以在工程的根目录下新建一个”gradle.properties”文件，然后加上一个标志位用来控制ModuleA中的”build.gradle”在不同编译情况下的不同处理逻辑。<br>  <img src="http://og407vfi8.bkt.clouddn.com/15225931350473.jpg" alt=""><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"> </div></pre></td></tr></table></figure></p>
<p>  然后在ModuleA的”build.gralde”中配置下面代码来控制它作为application构建还是作为library来构建。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (isModuleAIndependent.toBoolean()) &#123;</div><div class="line">    apply plugin: <span class="string">'com.android.application'</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    apply plugin: <span class="string">'com.android.library'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  在android标签下控制在不同构建情况下使用不同的AndroidManifest.xml。因为当module独立运行的时候需要入口activity在作为launcher，而在全module编译的时候又不需要这个入口activity，所以我们选择维护两套AndroidManifest来达到这个目的。<br>  最后在dependence里面也需要根据不同情况做不同处理。<br>  在做完了这些之后，只需修改gradle.properties中的变量，就可以达到单module构建的效果。实际测试下来编译时间从2min多提升到20sec多点，当然实际编译情况也要因机而异，反正我用下来是感觉爽了很多。</p>
<h2 id="组件化之路——存在的问题"><a href="#组件化之路——存在的问题" class="headerlink" title="组件化之路——存在的问题"></a>组件化之路——存在的问题</h2><p>  现阶段的组件化方案，虽然既满足了代码分离解构，同时又加快了开发效率，能够较好得支持团队业务的推进。但是仍然存在几个问题:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1. rpc的核心是使用反射的手段，使不同的模块间能够进行方法调用。方法调用有一个缺陷是，对于异步的请求，不能够实现很好的回调。</div><div class="line">现在一个中庸的解决方案是：在定义模块的对外接口的时候，方法中传入一个action，作为调用获得结果后的回调处理。而回调则是通过rxBus来定义event来实现的。且该rxBus的subscrption需要绑定到外部调用者的activity的生命周期中(确保该activity被销毁后，不会执行回调)。但是该方案依然会带来问题：1.较多的event定义类；2.代码碎片化(回调处要post一个event出去)；3.调用者必须传入activity用于subscription的生命周期管理。</div><div class="line">2. lib_basic_biz中聚集了很多的小的通用业务类，还有方法类等。在以后业务逐庞大后，该module难以满足大家的需求。 现阶段由于业务体量还不是很大，所以该设计轻巧便捷。若日后通用的业务组件加多的时候，我们可以考虑把这块分一分，即把业务分组。</div></pre></td></tr></table></figure>
<p>  由于项目进入到稳定期，对于组件化的拓展已经逐渐的减缓了下来，但是对于组件化的思考还在不断的进行着，由于目前的能力与眼界还有限，目前只有不断地学习，希望在今后能够继续完善组件化。<br>  组件化之路道阻且长。</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/10/20/2018-03-23/" class="archive-article-date">
  	<time datetime="2017-10-19T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-10-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android学习/">Android学习</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
  
    <a href="/2017/09/20/2018-04-01/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Android各新版本变化小结(持续更新)</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>




<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
	    <a class="jiathis_button_twitter"></a>
	    <a class="jiathis_button_plus"></a> 
	    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="2018-03-23" data-title="Android项目组件化尝试小结" data-url="http://zksyp.com/2017/10/20/2018-03-23/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"zksyp-hexo"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>





      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2018 Zksyp
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: true,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/Android学习/" style="font-size: 20px;">Android学习</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Java学习/" style="font-size: 15px;">Java学习</a> <a href="/tags/Java设计模式/" style="font-size: 15px;">Java设计模式</a> <a href="/tags/git代码管理/" style="font-size: 10px;">git代码管理</a>
    			</div>
    	</section>
    

    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">Zksyp,&lt;br&gt;一枚小小的码农。&lt;br/&gt;</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>